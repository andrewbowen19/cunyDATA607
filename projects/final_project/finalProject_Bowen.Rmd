---
title: "DATA 607 Final Project"
author: "Andrew Bowen"
date: "2022-11-23"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, echo=FALSE, message=FALSE}
library(httr)
library(jsonlite)
library(tidyverse)
library(sf) # for geospatial data lookup
library(glue)
```
## Motivation
- **Research Question**: Do environmental factors (like air quality) impact a student's academic performance?

## Datasources
- [AQ Air Quality Public REST API](https://docs.openaq.org/reference/introduction-1)
- [Open Weather Map API](https://openweathermap.org/api)
- [NYC Open Data Education files on test results](https://data.cityofnewyork.us/browse?category=Education&q=Test&sortBy=relevance) : while not a perfect indicator of academic performance, these do give some insight into the academic progress of students in different areas of the city.

## Academic Performance Data
- [Dataset from NYC Open Data](https://data.cityofnewyork.us/Education/2006-2012-Math-Test-Results-All-Students/3mrr-8h5c/data) (csv) -- test results by student.
- Can use District Borough Number (DBN) to lookup geographic locations and compare against AQ data
```{r, echo=TRUE}
dbn_url <- "https://raw.githubusercontent.com/andrewbowen19/cunyDATA607/main/projects/final_project/2006_-_2012__Math_Test_Results__-_All_Students.csv"

tests <- read.csv(dbn_url)

head(tests)
```



## Getting School Geospatial Data
Looking up [school district GIS data from NYC Open Data](https://data.cityofnewyork.us/Education/School-Districts/r8nu-ymqj). School point locations can be found [here](https://data.cityofnewyork.us/Education/School-Point-Locations/jfju-ynrr), we'll download them and unzip the file to get the shp file
```{r}
# Create temporary files
temp <- tempfile()
temp2 <- tempfile()

# Download the zip file and save to 'temp' 
school_locs_url <- "https://data.cityofnewyork.us/download/jfju-ynrr/application%2Fzip"
download.file(school_locs_url, temp)

# Unzip the folder contents and then read in the shp file to a dataframe
unzip(zipfile = temp, exdir = temp2)
school_locs <- sf::read_sf(temp2)
```

```{r}
# Cleaning and re-naming the ATS_CODE column to 
school_locs <- school_locs %>% 
                  dplyr::rename( "DBN"="ATS_CODE")
school_locs$DBN <- str_replace_all(school_locs$DBN, "\\s+", "")

# Projected CRS: NAD83
school_locs_sf <- st_as_sf(school_locs, coords=c("YCoord", "XCoord"), NAD83)

school_locs <- st_transform(school_locs_sf, crs = 4326 ) %>%
      mutate( lat = st_coordinates(.)[,2],lon = st_coordinates(.)[,1])
```

## Joining & Cleaning Academic Data
Let's join our `school_locs` dataframe to our `tests` 
```{r}
school_data <- left_join(tests, school_locs, by="DBN")
```

## Pulling Air Quality Data for New York City

Looking up air quality for school locations in [New York's geographical area](https://www.latlong.net/place/new-york-city-ny-usa-1848.html). Using my free API key from [the Open Weather Map API](https://openweathermap.org/api). Setting this as an environment variable
```{r}
# Reading our API key via environment variable. This will be included in submission for reproduction
apiKey <- Sys.getenv("OPENWEATHER_API_KEY")

# TODO: update return type (just aggregated AQ rating)
lookupAQ <- function(lat, lon, year=2022){
  
  start_time <- as.numeric(as.POSIXct(glue("{year}-01-01 0:00:00 EST")))
  end_time <- as.numeric(as.POSIXct(glue("{year}-12-31 23:59:59 EST")))
  # url <- glue("http://api.openweathermap.org/data/2.5/air_pollution/history?lat={lat}&lon={lon}&start={start_time}&end={end_time}&appid={apiKey}")
  print(url)
  url <- "http://api.openweathermap.org/data/2.5/air_pollution/history"
  query = list(
    lat = lat,
    lon = lon,

    start = start_time,
    end = end_time,
    appID = apiKey

    
    
  )
  
  response <- VERB("GET", url, query=query)

  return(aq_df <- as.data.frame(fromJSON(content(response, "text"))))
}

sample_aq <- lookupAQ(40.72189, 73.978, 2021)

```


## Cleaning Air Quality Data
First, we'll need to pull latitudes and longitudes from our `school_data` dataframe to pass to our `lookupAQ` 
```{r}
# TODO: figure out how we want to format return  types 

# Grouping by school and aggregating over year to minimize API calls
# school_data$Mean.Scale.Score = as.double(school_data$Mean.Scale.Score)
# school_data <- school_data %>%
#                 filter(!is.na(Mean.Scale.Score) & Mean.Scale.Score != "s") %>%
#                 mutate(mean_scaled_score = as.double(Mean.Scale.Score))

head(school_data)
# school_data$aq <- mapply(FUN=lookupAQ, lat =school_data$lat, lon=school_data$lon, year=school_data$Year)
```

Looking up Air Quality data for each school in our sample
```{r}
# Calling AQ API for data by school
aq_lookup <- mapply(FUN=lookupAQ, lat=school_data$lat, lon=school_data$lon,     year=school_data$Year)
```

```{r}
library(purrr)

school_sample <- school_data[c(1:10), ] %>%
                  mutate(lat = round(lat, 4), lon = round(lon, 4))

map_dfr(school_sample$lat, lookupAQ, lon=school_sample$lon, year=school_sample$Year)
```



```{r}
# Writing to CSV file to avoid future API calls in our analysis
# write.csv("school_aq_data.csv")
```




